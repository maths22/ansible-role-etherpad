---
- name: Preflight checks
  ansible.builtin.import_tasks: preflight.yml

- name: Ensure etherpad user is present
  user:
    name: "{{ etherpad_user }}"
    home: "{{ etherpad_home }}"
    shell: "/bin/bash"
    state: present

- name: Ensure ssh directory is present
  ansible.builtin.file:
    owner: "{{ etherpad_user }}"
    group: "{{ etherpad_user }}"
    mode: "0700"
    path: "{{ etherpad_repository_key_file | dirname }}"
    state: directory
  when:
    - etherpad_repository_key_file | length > 0

- name: Ensure ssh key file are latest
  copy:
    src: "{{ etherpad_repository_key_file_src }}"
    dest: "{{ etherpad_repository_key_file }}"
    owner: "{{ etherpad_user }}"
    group: "{{ etherpad_user }}"
    mode: "0600"
  when:
    - etherpad_repository_key_file_src | length > 0

- name: Ensure required packages are installed
  apt:
    pkg: "{{ etherpad_required_packages }}"
    state: present

- name: Ensure etherpad is latest
  git:
    repo: "{{ etherpad_repository }}"
    dest: "{{ etherpad_path }}"
    version: "{{ etherpad_repository_version }}"
    key_file: "{{ etherpad_repository_key_file }}"
    depth: 1
  become: true
  become_user: "{{ etherpad_user }}"
  register: etherpad_repository
  notify: Restart etherpad-lite

- name: Ensure etherpad config is latest
  template:
    src: settings.json.j2
    dest: "{{ etherpad_path }}/settings.json"
    owner: "{{ etherpad_user }}"
    group: "{{ etherpad_group }}"
    mode: 0640
  become: true
  become_user: "{{ etherpad_user }}"
  notify: Restart etherpad-lite
  no_log: true

- name: Import redis tasks
  import_tasks: redis.yml
  when: etherpad_db_type == "redis"

- name: Import mysql tasks
  import_tasks: mysql.yml
  when: etherpad_db_type == "mysql"

- name: Ensure etherpad systemd unit is latest
  template:
    src: etc/systemd/system/etherpad-lite.service.j2
    dest: /etc/systemd/system/etherpad-lite.service
    owner: root
    group: root
    mode: 0644
  notify: Reload systemd

- name: Ensure etherpad api key is latest
  template:
    src: APIKEY.txt.j2
    dest: "{{ etherpad_path }}/APIKEY.txt"
    owner: "{{ etherpad_user }}"
    group: "{{ etherpad_group }}"
    mode: 0640
  become: true
  become_user: "{{ etherpad_user }}"
  notify: Restart etherpad-lite
  no_log: true

- name: Install etherpad plugins # noqa no-changed-when
  community.general.npm:
    name: "{{ item.name }}"
    path: "{{ etherpad_path }}"
    state: "{{ item.state | default('present') }}"
    version: "{{ item.version | default(omit) }}"
    registry: "{{ item.registry | default(omit) }}"
  become: true
  become_user: "{{ etherpad_user }}"
  loop: "{{ etherpad_plugins }}"
  register: etherpad_plugins
  when: etherpad_plugins | length > 0
  notify: Restart etherpad-lite

- name: Install dependencies # noqa no-changed-when
  ansible.builtin.shell: |
    bin/installDeps.sh
  args:
    chdir: "{{ etherpad_path }}"
    executable: /bin/bash
  become: true
  become_user: "{{ etherpad_user }}"
  when: etherpad_repository.changed or etherpad_plugins.changed

- name: Copy custom logo file if configured
  copy:
    src: "{{ etherpad_custom_logo_src }}"
    dest: "{{ etherpad_path }}/src/static/"
    owner: "{{ etherpad_user }}"
    group: "{{ etherpad_group }}"
    mode: 0644
  when: etherpad_custom_logo_src is defined

- name: Import abiword tasks
  import_tasks: abiword.yml
  when: etherpad_abiword_enabled

- name: Ensure etherpad will start after system is booted
  service:
    name: etherpad-lite
    state: started
    enabled: yes
